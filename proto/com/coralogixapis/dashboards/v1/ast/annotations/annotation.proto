syntax = "proto3";

package com.coralogixapis.dashboards.v1.ast.annotations;

import "com/coralogixapis/dashboards/v1/ast/widgets/common/units.proto";
import "com/coralogixapis/dashboards/v1/common/data_mode_type.proto";
import "com/coralogixapis/dashboards/v1/common/observation_field.proto";
import "com/coralogixapis/dashboards/v1/common/query.proto";
import "google/protobuf/duration.proto";
import "google/protobuf/wrappers.proto";

message Annotation {
  // Annotation unique identifier
  google.protobuf.StringValue id = 1;
  google.protobuf.StringValue name = 2;
  google.protobuf.StringValue description = 5;
  google.protobuf.BoolValue enabled = 3;

  Source source = 4;
  WidgetScope scope = 6;

  message Source {
    oneof value {
      MetricsSource metrics = 1;
      LogsSource logs = 2;
      SpansSource spans = 3;
      DataprimeSource dataprime = 4;
      ManualSource manual = 5;
      EventRecurrenceSource event_recurrence = 6;
    }
  }

  message MetricsSource {
    v1.common.PromQlQuery promql_query = 1;
    Strategy strategy = 2;
    google.protobuf.StringValue message_template = 3;
    repeated google.protobuf.StringValue labels = 4;
    AnnotationOrientation orientation = 5;

    // A strategy for turning metrics data into annotations
    message Strategy {
      oneof value {
        // Take the first data point and use its value as annotation timestamp (instead of pointing to its own timestamp)
        StartTimeMetric start_time_metric = 1;
      }
    }

    message StartTimeMetric {}
  }

  message LogsSource {
    v1.common.LuceneQuery lucene_query = 1;
    Strategy strategy = 2;
    google.protobuf.StringValue message_template = 3;
    repeated common.ObservationField label_fields = 4;
    v1.common.DataModeType data_mode_type = 5;

    message Strategy {
      oneof value {
        Instant instant = 1;
        Range range = 2;
        Duration duration = 3;
      }

      message Instant {
        common.ObservationField timestamp_field = 1;
      }

      message Range {
        common.ObservationField start_timestamp_field = 1;
        common.ObservationField end_timestamp_field = 2;
      }

      message Duration {
        common.ObservationField start_timestamp_field = 1;
        common.ObservationField duration_field = 2;
      }
    }
  }

  message SpansSource {
    v1.common.LuceneQuery lucene_query = 1;
    Strategy strategy = 2;
    google.protobuf.StringValue message_template = 3;
    repeated common.ObservationField label_fields = 4;
    v1.common.DataModeType data_mode_type = 5;

    message Strategy {
      oneof value {
        Instant instant = 1;
        Range range = 2;
        Duration duration = 3;
      }

      message Instant {
        common.ObservationField timestamp_field = 1;
      }

      message Range {
        common.ObservationField start_timestamp_field = 1;
        common.ObservationField end_timestamp_field = 2;
      }

      message Duration {
        common.ObservationField start_timestamp_field = 1;
        common.ObservationField duration_field = 2;
      }
    }
  }

  message DataprimeSource {
    v1.common.DataprimeQuery query = 1;
    Strategy strategy = 2;
    google.protobuf.StringValue message_template = 3;
    v1.common.DataModeType data_mode_type = 4;
    repeated common.ObservationField label_fields = 5;
    AnnotationOrientation orientation = 6;

    message Strategy {
      oneof value {
        Instant instant = 1;
        Range range = 2;
        Duration duration = 3;
      }

      message Instant {
        common.ObservationField timestamp_field = 1;
      }

      message Range {
        common.ObservationField start_timestamp_field = 1;
        common.ObservationField end_timestamp_field = 2;
      }

      message Duration {
        common.ObservationField start_timestamp_field = 1;
        common.ObservationField duration_field = 2;
      }
    }
  }

  message ManualSource {
    Strategy strategy = 1;
    google.protobuf.StringValue message_template = 3;
    AnnotationOrientation orientation = 4;

    message Strategy {
      oneof value {
        Instant instant = 1;
        Range range = 2;
      }

      message Instant {
        widgets.common.Unit unit = 1;
        google.protobuf.DoubleValue value = 2;
        google.protobuf.StringValue custom_unit = 3;
      }

      message Range {
        widgets.common.Unit unit = 1;
        google.protobuf.DoubleValue start_value = 2;
        google.protobuf.DoubleValue end_value = 3;
        google.protobuf.StringValue custom_unit = 4;
      }
    }
  }

  message EventRecurrenceSource {
    Recurrence recurrence = 1;
    Strategy strategy = 2;
    google.protobuf.StringValue message_template = 3;

    message Recurrence {
      oneof frequency_type {
        WeeklyRecurrence weekly = 1;
      }
    }

    message WeeklyRecurrence {
      repeated Weekday days_of_week = 1;
    }

    message Strategy {
      oneof value {
        Instant instant = 1;
        Duration duration = 2;
      }

      message Instant {
        google.protobuf.Int32Value start_time_hour = 1;
      }

      message Duration {
        google.protobuf.Int32Value start_time_hour = 1;
        google.protobuf.Duration duration = 2;
      }
    }

    enum Weekday {
      WEEKDAY_UNSPECIFIED = 0;
      WEEKDAY_MONDAY = 1;
      WEEKDAY_TUESDAY = 2;
      WEEKDAY_WEDNESDAY = 3;
      WEEKDAY_THURSDAY = 4;
      WEEKDAY_FRIDAY = 5;
      WEEKDAY_SATURDAY = 6;
      WEEKDAY_SUNDAY = 7;
    }
  }

  message WidgetScope {
    oneof value {
      AllWidgets all_widgets = 1;
      SpecificWidgets specific_widgets = 2;
    }

    message AllWidgets {}

    message SpecificWidgets {
      repeated google.protobuf.StringValue widget_ids = 1;
    }
  }

  enum AnnotationOrientation {
    ANNOTATION_ORIENTATION_VERTICAL_UNSPECIFIED = 0;
    ANNOTATION_ORIENTATION_HORIZONTAL = 1;
  }
}
